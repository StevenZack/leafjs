function Observable(e){var t={__observers:[],value:e,postValue:function(e){if("function"==typeof e&&(e=e(this.value)),typeof e!=typeof this.value)throw new Error("postValue() type mismatch: "+typeof e+" vs "+typeof this.value);if(e!==this.value){this.value=e;for(var t=0;t<this.__observers.length;t++)this.__observers[t](this.value)}},update:function(e){e(this.value),this.notifyChange()},notifyChange:function(){for(var e=0;e<this.__observers.length;e++)this.__observers[e](this.value)}};return e instanceof Array?(t.append=function(e){if(!(this.value instanceof Array))throw new Error("invalid operation: calling append on a non-array observable value");this.value.push(e),this.notifyChange()},t.removeAt=function(e){if("number"!=typeof e)throw new Error("removeAt() argument type is not number");this.value.splice(e,1),this.notifyChange()},t.replace=function(e,t){if("number"!=typeof e)throw new Error("removeAt() argument type is not number");this.value.splice(e,1,t),this.notifyChange()},t.insertAfter=function(e,t){if("number"!=typeof e)throw new Error("removeAt() argument type is not number");this.value.splice(e,0,t),this.notifyChange()}):"number"==typeof e?t.inc=function(e){if(e){if("number"!=typeof e)throw new Error("invalid input type for inc():"+typeof e);this.value+=e}else this.value++;this.notifyChange()}:"boolean"==typeof e&&(t.toggle=function(){this.value=!this.value,this.notifyChange()}),t}function __leaf_removeInArray(e,t){if(!(e instanceof Array))throw new Error("array type is not Array");for(var r=0;r<e.length;r++)if(t===e[r])return e.splice(r,1),!0;return!1}function __leaf_executeToken(__leaf_token_origin,$,__leaf_extraData,unwrapData){eval(unwrapData?__leaf_unwrapVariablesOfany($,"$"):""),eval(__leaf_unwrapVariablesOfany(__leaf_extraData,"__leaf_extraData"));try{var result=eval(__leaf_token_origin);return result&&result.postValue&&result.__observers?result.value:result}catch(e){throw console.log($),console.log(__leaf_extraData),e}}function __leaf_unwrapVariablesOfany(e,t){if(!e)return"";if("object"!=typeof e)return"";var r="";for(var n in e){var i=e[n],a="var "+n+"="+t+"."+n;!i.__observers||!i.postValue||i.value instanceof Array||(a+=".value"),r+=a+";"}return r}function Leaf(e,t){var r=document.getElementById(e);if(!(r&&r instanceof HTMLElement))throw new Error("Leaf() first argument type is not HTMLElement or string(id of the element): "+r);var n=new Dom(null,r,new __LeafContext(t,{_root:t},!0));return n.execute(!1),t}function embedHTML(e,t,r){if(t){if("string"==typeof t){var n=document.getElementById(t);if(null==n)throw new Error("element with id ["+t+"] not found");o=n}else{if(!(t&&t instanceof HTMLElement))throw new Error("Leaf() first argument type is not HTMLElement or string(id of the element): "+t);o=t}if(r||(r=o.getAttribute("src")),!r)throw new Error("template.src not set:"+o.outerHTML);__leaf_embedHTML(o,r,e)}else{var i=document.getElementsByTagName("template");if(i)for(var a=0,s=0;s<i.length;s++){var o=i[s];r=o.getAttribute("src");r&&(a++,__leaf_embedHTML(o,r,function(){a--,a<=0&&e&&e()}))}}}function __leaf_embedHTML(e,t,r){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(r&&r(),200===n.status?e.outerHTML=n.responseText:e.innerText=n.status+": "+n.responseText)},n.open("GET",t),n.send()}function __leaf_generateID(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=r.length,i=0;i<e;)t+=r.charAt(Math.floor(Math.random()*n)),i+=1;return t="___"+t+"___",__leaf_randomIDs[t]?__leaf_generateID(e):(__leaf_randomIDs[t]=!0,t)}function __leaf_isEnglishAlphabet(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_",r=0;r<t.length;r++)if(e===t.charAt(r))return!0;return!1}function __leaf_createElemByString(e){var t=document.createElement("div");return t.innerHTML=e,t.firstChild}function __leaf_isVariableName(e){if(!e)return!1;for(var t=0;t<e.length;t++)if(!__leaf_isEnglishAlphabet(e.charAt(t)))return!1;return!0}function __leaf_startsWith(e,t){return!(e.length<t.length)&&e.substring(0,t.length)===t}function __leaf_removeClass(e,t){var r=e.getAttribute("class");if(r){for(var n="",i=r.split(" "),a=0;a<i.length;a++)i[a]&&i[a]!==t&&(n+=i[a]);e.setAttribute("class",n)}}function __leaf_addClass(e,t){var r=e.getAttribute("class");if(r){for(var n=r.split(" "),i=0;i<n.length;i++)if(n[i]&&n[i]===t)return;e.setAttribute("class",r+" "+t)}else e.setAttribute("class",t)}function __leaf_copyeObject(e){var t={};for(var r in e){var n=e[r];"object"!=typeof n?t[r]=n:t[r]=__leaf_copyeObject(n)}return t}function __leaf_sanitizeHTML(e){if(e+="","string"==typeof e)return e=e.replace("<","&lt;"),e=e.replace(">","&gt;"),e}function __leaf_desanitizeHTML(e){if("string"==typeof e)return e=e.replace("&lt;","<"),e=e.replace("&gt;",">"),e}var Dom=function(){function e(t,r,n){this.children=[],this.attributes=[],this.unbindObservables=[],this.parentDom=t,this.elem=r,this.context=n;for(var i=0;i<this.elem.attributes.length;i++){var a=this.elem.attributes[i];if("l-for"===a.name)return this.transformIntoLFor(a.value),this;__leaf_startsWith(a.name,"l-")&&this.attributes.push(new LeafAttribute(this,a.name,a.value))}LeafTextContent.checkIfNeeded(this)&&(this.textContent=new LeafTextContent(this));for(i=0;i<r.children.length;i++)this.children.push(new e(this,r.children[i],this.context));return this}return e.prototype.transformIntoLFor=function(e){this.elem.setAttribute("__leaf_for_item__",e),this.elem.removeAttribute("l-for"),this.lForTemplate=this.elem.outerHTML,this.elem.style.display="none",this.lForTokenOrigin=e;var t=e.split(" "),r="",n="",i="";this.siblings=[];for(var a=0;a<t.length;a++){var s=t[a].replace(" ","");if(s){if(!r){if(!__leaf_isVariableName(s))continue;var o=this.context.data[s];if(!o)throw console.error(this.context),new Error("value ["+s+"] in token {{"+e+"}} not found");if(o.postValue&&o.__observers){var l=o.value;if(!(l&&l instanceof Array))throw new Error("value type in token {{"+e+"}} is not an Array or Observable<Array>");r=s;continue}if(o instanceof Array){r=s;continue}throw new Error("value type in token {{"+e+"}} is not an Array or Observable<Array>")}if("as"!==s){if(!n){if(s.indexOf(",")>-1){var h=s.split(",");if(2!=h.length)throw new Error("invalid token for l-for {{"+e+"}}");if(n=h[0],!__leaf_isVariableName(n))throw new Error("invalid token for l-for {{"+e+"}}");if(this.context.data[n])throw new Error("invalid token for l-for {{"+e+"}}, duplicated name :"+n);if(i=h[1],!__leaf_isVariableName(i))throw new Error("invalid token for l-for {{"+e+"}}");if(this.context.data[n])throw new Error("invalid token for l-for {{"+e+"}}, duplicated name :"+i);break}if(n=s,!__leaf_isVariableName(n))throw new Error("invalid token for l-for {{"+e+"}}");if(this.context.data[n])throw new Error("invalid token for l-for {{"+e+"}}, duplicated name :"+n);break}break}}}this.listKey=r,this.asItemKey=n,this.asIndexKey=i,this.asIndexKey||(this.asIndexKey="_index"),this.context=new __LeafContext(this.context.data,this.context.extraData,!n),LeafTextContent.checkIfNeeded(this)&&(this.textContent=new LeafTextContent(this));var f,u,_,c=this.getListData();c.__observers&&c.postValue&&(f=c,u=this,_=function(){u.executeArray()},f.__observers.push(_),u.unbindObservables.push(function(){__leaf_removeInArray(f.__observers,_)}))},e.prototype.rebind=function(){for(var e=0;e<this.unbindObservables.length;e++)this.unbindObservables[e]();if(this.unbindObservables=[],this.listKey){var t=this.getListData();t.__observers&&t.postValue&&(r=t,n=this,i=function(){n.executeArray()},r.__observers.push(i),n.unbindObservables.push(function(){__leaf_removeInArray(r.__observers,i)}))}var r,n,i;for(e=0;e<this.attributes.length;e++)this.attributes[e].rebind();this.textContent&&this.textContent.rebind();for(e=0;e<this.children.length;e++)this.children[e].rebind()},e.prototype.execute=function(e){if(e||!this.listKey){for(var t=0;t<this.attributes.length;t++)this.attributes[t].execute();this.textContent&&this.textContent.execute();for(t=0;t<this.children.length;t++)this.children[t].execute(!1)}else this.executeArray()},e.prototype.getListData=function(){if(!this.listKey)throw new Error("listKey is empty, means this dom is not a l-for dom");if(!this.parentDom)throw new Error("l-for element has no parent dom, which is not allowed");return this.parentDom.context.data[this.listKey]},e.prototype.executeArray=function(){var t=this.getListData();if(!t)throw console.error(this.context),new Error("l-for: array value not found in data. {{"+this.listKey+"}}");if(t.__observers&&t.postValue&&(t=t.value),!(t&&t instanceof Array))throw console.error(t),new Error("l-for: value {{"+this.listKey+"}} is not Array type");if(!this.parentDom)throw new Error("parent Dom not found");for(var r=[],n=[],i=0;i<this.siblings.length||i<t.length;i++)if(i>=t.length)r.push(this.siblings[i]);else if(i<this.siblings.length){var a=this.siblings[i];if(a.context.data=t[i],a.context.extraData[this.asIndexKey]=i,!this.context.unwrapData){if(!this.asItemKey)throw new Error("this.asItemKey is empty");a.context.extraData[this.asItemKey]=t[i]}a.execute(!0),a.rebind()}else{var s=t[i],o=new __LeafContext(s,__leaf_copyeObject(this.context.extraData),this.context.unwrapData);if(o.extraData[this.asIndexKey]=i,!this.context.unwrapData){if(!this.asItemKey)throw new Error("this.asItemKey is empty");o.extraData[this.asItemKey]=o.data}var l=new e(null,__leaf_createElemByString(this.lForTemplate),o);n.push(l),l.execute(!0)}for(i=0;i<r.length;i++)__leaf_removeInArray(this.siblings,r[i]),this.parentDom.elem.removeChild(r[i].elem);var h=-1;for(i=0;i<this.parentDom.elem.children.length;i++)if(this.parentDom.elem.children[i].getAttribute("__leaf_for_item__")!==this.lForTokenOrigin){if(h>-1)break}else h=i;if(-1===h)throw new Error("suffix index of domList is not found: this means leaf.js unexpectedly delete the hidden first element of l-for, now we couldn't find it any more");var f=null;h<this.parentDom.elem.children.length-1&&(f=this.parentDom.elem.children[h+1]);for(i=0;i<n.length;i++)f?this.parentDom.elem.insertBefore(n[i].elem,f):this.parentDom.elem.appendChild(n[i].elem),this.siblings.push(n[i])},e}(),LeafToken=function(){function LeafToken(e,t){return this.observableRefs=[],this.dom=e,this.origin=t,this.collectObservables(),this}return LeafToken.prototype.collectObservables=function(){this.observableRefs=[];for(var variableStarted=-1,singleQuoteStarted=-1,doubleQuoteStarted=-1,i=0;i<this.origin.length;i++){var char=this.origin[i];if('"'!==char)if("'"!==char){if(!(singleQuoteStarted>-1||doubleQuoteStarted>-1))if(__leaf_isEnglishAlphabet(char)||"."===char){if(-1===variableStarted){variableStarted=i;continue}}else if(-1!==variableStarted){var variableName=this.origin.substring(variableStarted,i),observable;try{observable=eval("this.dom.context.data."+variableName)}catch(e){}if(!observable)try{observable=eval("this.dom.context.extraData."+variableName)}catch(e){}observable&&observable.postValue&&observable.__observers&&this.observableRefs.push(observable),variableStarted=-1}}else singleQuoteStarted=-1===singleQuoteStarted?i:-1;else doubleQuoteStarted=-1===doubleQuoteStarted?i:-1}if(-1!==variableStarted){var variableName=this.origin.substring(variableStarted,this.origin.length),observable;try{observable=eval("this.dom.context.data."+variableName)}catch(e){}if(!observable)try{observable=eval("this.dom.context.extraData."+variableName)}catch(e){}observable&&observable.postValue&&observable.__observers&&this.observableRefs.push(observable)}},LeafToken.prototype.execute=function(){var e=__leaf_executeToken(this.origin,this.dom.context.data,this.dom.context.extraData,this.dom.context.unwrapData);return e},LeafToken}(),LeafAttribute=function(){function e(e,t,r){if(this.value="",!__leaf_startsWith(t,"l-"))throw new Error("invalid executable attribute:"+t);if(this.dom=e,this.name=t.substring(2),this.tokenOrigin=r,this.token=new LeafToken(this.dom,this.tokenOrigin),__leaf_startsWith(this.name,"style-"))this.value=this.name.substring(6),this.name="style";else if(__leaf_startsWith(this.name,"class:"))this.value=this.name.substring(6),this.name="class";else if("for"===this.name)return this;for(var n=0;n<this.token.observableRefs.length;n++)(function(e,t){var r=function(t){e.execute()};t.__observers.push(r),e.dom.unbindObservables.push(function(){var e=__leaf_removeInArray(t.__observers,r);e||console.error("unbind attribute failed")})})(this,this.token.observableRefs[n]);return this}return e.prototype.rebind=function(){if(this.token.collectObservables(),__leaf_startsWith(this.name,"style-"))this.value=this.name.substring(6),this.name="style";else if(__leaf_startsWith(this.name,"class:"))this.value=this.name.substring(6),this.name="class";else if("for"===this.name)return this;for(var e=0;e<this.token.observableRefs.length;e++)(function(e,t){var r=function(t){e.execute()};t.__observers.push(r),e.dom.unbindObservables.push(function(){__leaf_removeInArray(t.__observers,r)||console.error("rebind attribute failed")})})(this,this.token.observableRefs[e])},e.prototype.execute=function(){var e=this.token.execute();e&&e.__observers&&e.postValue&&(e=e.value),"class"!==this.name?"if"!==this.name?"boolean"!=typeof e?"value"===this.name?this.dom.elem.value=e:this.dom.elem.setAttribute(this.name,e):e?this.dom.elem.setAttribute(this.name,this.value):this.dom.elem.removeAttribute(this.name):this.dom.elem.style.display=e?"":"none":e?__leaf_addClass(this.dom.elem,this.value):__leaf_removeClass(this.dom.elem,this.value)},e}(),LeafTextContent=function(){function e(e){this.tokens=[],this.template="",this.dom=e;for(var t=e.elem.childNodes,r=[],n=function(e,t){for(var n=0;n<r.length;n++)if(r[n]===e)return!0;return!1},i=0;i<t.length;i++)for(var a=String(t[i].nodeValue),s=-1,o=0;o<a.length;o++){var l=a.charAt(o),h="";if(o<a.length-1&&(h=a.charAt(o+1)),l+h!=="{{")if(s>-1&&l+h==="}}"){var f=a.substring(s+2,o),u=new LeafToken(this.dom,f);u.uniqueID=__leaf_generateID(16);for(var _=0;_<u.observableRefs.length;_++){var c=u.observableRefs[_];n(c,r)||(r.push(c),function(e,t){var r=function(t){e.execute()};t.__observers.push(r),e.dom.unbindObservables.push(function(){__leaf_removeInArray(t.__observers,r)})}(this,c))}this.tokens.push(u),s=-1,o++,this.template+=u.uniqueID}else-1===s&&(this.template+=l);else s=o}}return e.prototype.rebind=function(){for(var e=0;e<this.tokens.length;e++){this.tokens[e].collectObservables();for(var t=0;t<this.tokens[e].observableRefs.length;t++){var r=this.tokens[e].observableRefs[t];(function(e,t){var r=function(t){e.execute()};t.__observers.push(r),e.dom.unbindObservables.push(function(){__leaf_removeInArray(t.__observers,r)||console.error("rebind text content failed:")})})(this,r)}}},e.prototype.execute=function(){for(var e=this.template,t=0;t<this.tokens.length;t++){var r=this.tokens[t].execute();e=e.replace(this.tokens[t].uniqueID,r)}this.dom.elem.innerHTML=__leaf_sanitizeHTML(e)},e.checkIfNeeded=function(e){var t=e.elem.childNodes;if(e.elem.children.length>0){for(var r=0;r<t.length;r++){var n=t[r];if(n&&n instanceof Node){var i=String(n.nodeValue);if(i.indexOf("{{")>-1)throw new Error("Leaf.js currently don't support textContent binding with parentNode's other children.length>0, it may lost the binding connection when textContent update. Please wrap your textContent with a <span> or <div>: "+i)}}return!1}return e.elem.textContent.indexOf("{{")>-1},e}(),__leaf_randomIDs={},__LeafContext=function(){function e(e,t,r){this.data=e,this.extraData=t,this.unwrapData=r}return e}();