function Observable(e){var t={__observers:[],value:e,postValue:function(e){if("function"==typeof e&&(e=e(this.value)),typeof e!=typeof this.value)throw new Error("postValue() type mismatch: "+typeof e+" vs "+typeof this.value);if(e!==this.value){this.value=e;for(var t=0;t<this.__observers.length;t++)this.__observers[t](this.value)}},update:function(e){e(this.value),this.notifyChange()},notifyChange:function(){for(var e=0;e<this.__observers.length;e++)this.__observers[e](this.value)}};return e instanceof Array?(t.append=function(e){if(!(this.value instanceof Array))throw new Error("invalid operation: calling append on a non-array observable value");this.value.push(e),this.notifyChange()},t.removeAt=function(e){if("number"!=typeof e)throw new Error("removeAt() argument type is not number");this.value.splice(e,1),this.notifyChange()},t.replace=function(e,t){if("number"!=typeof e)throw new Error("removeAt() argument type is not number");this.value.splice(e,1,t),this.notifyChange()},t.insertAfter=function(e,t){if("number"!=typeof e)throw new Error("removeAt() argument type is not number");this.value.splice(e,0,t),this.notifyChange()}):"number"==typeof e?t.inc=function(e){if(e){if("number"!=typeof e)throw new Error("invalid input type for inc():"+typeof e);this.value+=e}else this.value++;this.notifyChange()}:"boolean"==typeof e&&(t.toggle=function(){this.value=!this.value,this.notifyChange()}),t}function __leaf_removeInArray(e,t){if(!(e instanceof Array))throw new Error("array type is not Array");for(var r=0;r<e.length;r++)if(t===e[r])return e.splice(r,1),!0;return!1}function __leaf_executeToken(__leaf_token_origin,$,__leaf_extraData,unwrapData){eval(unwrapData?__leaf_unwrapVariablesOfany($,"$"):""),eval(__leaf_unwrapVariablesOfany(__leaf_extraData,"__leaf_extraData"));try{var result=eval(__leaf_token_origin);return result&&result.postValue&&result.__observers?result.value:result}catch(e){throw console.log($),console.log(__leaf_extraData),e}}function __leaf_unwrapVariablesOfany(e,t){if(!e)return"";if("object"!=typeof e)return"";var r="";for(var a in e){var n=e[a],i="var "+a+"="+t+"."+a;!n.__observers||!n.postValue||n.value instanceof Array||(i+=".value"),r+=i+";"}return r}function Leaf(e,t){var r=document.getElementById(e);if(!(r&&r instanceof HTMLElement))throw new Error("Leaf() first argument type is not HTMLElement or string(id of the element): "+r);var a=new Dom(null,r,new __LeafContext(t,{_root:t},!0));return a.execute(!1),t}function embedHTML(e,t){if(t){if("string"==typeof t){var r=document.getElementById(t);if(null==r)throw new Error("element with id ["+t+"] not found");o=r}else{if(!(t&&t instanceof HTMLElement))throw new Error("Leaf() first argument type is not HTMLElement or string(id of the element): "+t);o=t}var a=o.getAttribute("src");if(!a)throw new Error("template.src not set:"+o.outerHTML);__leaf_embedHTML(o,a,e)}else{var n=document.getElementsByTagName("template");if(n)for(var i=0,s=0;s<n.length;s++){var o=n[s];a=o.getAttribute("src");a&&(i++,__leaf_embedHTML(o,a,function(){i--,i<=0&&e&&e()}))}}}function __leaf_embedHTML(e,t,r){var a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState&&(r&&r(),200===a.status?e.outerHTML=a.responseText:e.innerText=a.status+": "+a.responseText)},a.open("GET",t),a.send()}function __leaf_generateID(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=r.length,n=0;n<e;)t+=r.charAt(Math.floor(Math.random()*a)),n+=1;return t="___"+t+"___",__leaf_randomIDs[t]?__leaf_generateID(e):(__leaf_randomIDs[t]=!0,t)}function __leaf_isEnglishAlphabet(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_",r=0;r<t.length;r++)if(e===t.charAt(r))return!0;return!1}function __leaf_createElemByString(e){var t=document.createElement("div");return t.innerHTML=e,t.firstChild}function __leaf_isVariableName(e){if(!e)return!1;for(var t=0;t<e.length;t++)if(!__leaf_isEnglishAlphabet(e.charAt(t)))return!1;return!0}function __leaf_startsWith(e,t){return!(e.length<t.length)&&e.substring(0,t.length)===t}function __leaf_endsWith(e,t){return!(e.length<t.length)&&e.substring(e.length-t.length,e.length)===t}function __leaf_removeClass(e,t){var r=e.getAttribute("class");if(r){for(var a="",n=r.split(" "),i=0;i<n.length;i++)n[i]&&n[i]!==t&&(a+=n[i]+" ");e.setAttribute("class",a)}}function __leaf_addClass(e,t){var r=e.getAttribute("class");if(r){for(var a=r.split(" "),n=0;n<a.length;n++)if(a[n]&&a[n]===t)return;e.setAttribute("class",r+" "+t)}else e.setAttribute("class",t)}function __leaf_copyeObject(e){if(e instanceof Array){for(var t=[],r=0;r<e.length;r++){var a=e[r];"object"==typeof s&&(a=__leaf_copyeObject(a)),t.push(a)}return t}var n={};for(var i in e){var s=e[i];"_root"!==i?n[i]="object"!=typeof s?s:__leaf_copyeObject(s):n[i]=s}return n}function __leaf_sanitizeHTML(e){if(e+="","string"==typeof e)return e=e.replace("<","&lt;"),e=e.replace(">","&gt;"),e}function __leaf_desanitizeHTML(e){if("string"==typeof e)return e=e.replace("&lt;","<"),e=e.replace("&gt;",">"),e}var Dom=function(){function e(t,r,a){this.children=[],this.attributes=[],this.unbindObservables=[],this.parentDom=t,this.elem=r,this.context=a;for(var n=0;n<this.elem.attributes.length;n++){var i=this.elem.attributes[n];if("l-for"===i.name)return this.transformIntoLFor(i.value),this;__leaf_startsWith(i.name,"l-")&&this.attributes.push(new LeafAttribute(this,i.name,i.value))}LeafTextContent.checkIfNeeded(this)&&(this.textContent=new LeafTextContent(this));for(n=0;n<r.children.length;n++)this.children.push(new e(this,r.children[n],this.context));return this}return e.prototype.transformIntoLFor=function(e){this.elem.setAttribute("__leaf_for_item__",e),this.elem.removeAttribute("l-for"),this.lForTemplate=this.elem.outerHTML,this.elem.style.display="none",this.lForTokenOrigin=e;var t=e.split(" "),r="",a="",n="";this.siblings=[];for(var i=0;i<t.length;i++){var s=t[i].replace(" ","");if(s){if(!r){if(!__leaf_isVariableName(s))continue;var o=this.context.data[s];if(!o)throw console.error(this.context),new Error("value ["+s+"] in token {{"+e+"}} not found");if(o.postValue&&o.__observers){var l=o.value;if(!(l&&l instanceof Array))throw new Error("value type in token {{"+e+"}} is not an Array or Observable<Array>");r=s;continue}if(o instanceof Array){r=s;continue}throw new Error("value type in token {{"+e+"}} is not an Array or Observable<Array>")}if("as"!==s){if(!a){if(s.indexOf(",")>-1){var h=s.split(",");if(2!=h.length)throw new Error("invalid token for l-for {{"+e+"}}");if(a=h[0],!__leaf_isVariableName(a))throw new Error("invalid token for l-for {{"+e+"}}");if(this.context.data[a])throw new Error("invalid token for l-for {{"+e+"}}, duplicated name :"+a);if(n=h[1],!__leaf_isVariableName(n))throw new Error("invalid token for l-for {{"+e+"}}");if(this.context.data[a])throw new Error("invalid token for l-for {{"+e+"}}, duplicated name :"+n);break}if(a=s,!__leaf_isVariableName(a))throw new Error("invalid token for l-for {{"+e+"}}");if(this.context.data[a])throw new Error("invalid token for l-for {{"+e+"}}, duplicated name :"+a);break}break}}}this.listKey=r,this.asItemKey=a,this.asIndexKey=n,this.asIndexKey||(this.asIndexKey="_index"),this.context=new __LeafContext(this.context.data,this.context.extraData,!a),LeafTextContent.checkIfNeeded(this)&&(this.textContent=new LeafTextContent(this));var f,u,b,v=this.getListData();v.__observers&&v.postValue&&(f=v,u=this,b=function(){u.executeArray()},f.__observers.push(b),u.unbindObservables.push(function(){__leaf_removeInArray(f.__observers,b)}))},e.prototype.rebind=function(){for(var e=0;e<this.unbindObservables.length;e++)this.unbindObservables[e]();if(this.unbindObservables=[],this.listKey){var t=this.getListData();t.__observers&&t.postValue&&(r=t,a=this,n=function(){a.executeArray()},r.__observers.push(n),a.unbindObservables.push(function(){__leaf_removeInArray(r.__observers,n)}))}var r,a,n;for(e=0;e<this.attributes.length;e++)this.attributes[e].rebind();this.textContent&&this.textContent.rebind();for(e=0;e<this.children.length;e++)this.children[e].rebind()},e.prototype.execute=function(e){if(e||!this.listKey){for(var t=0;t<this.attributes.length;t++)this.attributes[t].execute();this.textContent&&this.textContent.execute();for(t=0;t<this.children.length;t++)this.children[t].execute(!1)}else this.executeArray()},e.prototype.getListData=function(){if(!this.listKey)throw new Error("listKey is empty, means this dom is not a l-for dom");if(!this.parentDom)throw new Error("l-for element has no parent dom, which is not allowed");return this.parentDom.context.data[this.listKey]},e.prototype.executeArray=function(){var t=this.getListData();if(!t)throw console.error(this.context),new Error("l-for: array value not found in data. {{"+this.listKey+"}}");if(t.__observers&&t.postValue&&(t=t.value),!(t&&t instanceof Array))throw console.error(t),new Error("l-for: value {{"+this.listKey+"}} is not Array type");if(!this.parentDom)throw new Error("parent Dom not found");for(var r=[],a=[],n=0;n<this.siblings.length||n<t.length;n++)if(n>=t.length)r.push(this.siblings[n]);else if(n<this.siblings.length){var i=this.siblings[n];if(i.context.data=t[n],i.context.extraData[this.asIndexKey]=n,!this.context.unwrapData){if(!this.asItemKey)throw new Error("this.asItemKey is empty");i.context.extraData[this.asItemKey]=t[n]}i.execute(!0),i.rebind()}else{var s=t[n],o=new __LeafContext(s,__leaf_copyeObject(this.context.extraData),this.context.unwrapData);if(o.extraData[this.asIndexKey]=n,!this.context.unwrapData){if(!this.asItemKey)throw new Error("this.asItemKey is empty");o.extraData[this.asItemKey]=o.data}var l=new e(null,__leaf_createElemByString(this.lForTemplate),o);a.push(l),l.execute(!0)}for(n=0;n<r.length;n++)__leaf_removeInArray(this.siblings,r[n]),this.parentDom.elem.removeChild(r[n].elem);var h=-1;for(n=0;n<this.parentDom.elem.children.length;n++)if(this.parentDom.elem.children[n].getAttribute("__leaf_for_item__")!==this.lForTokenOrigin){if(h>-1)break}else h=n;if(-1===h)throw new Error("suffix index of domList is not found: this means leaf.js unexpectedly delete the hidden first element of l-for, now we couldn't find it any more");var f=null;h<this.parentDom.elem.children.length-1&&(f=this.parentDom.elem.children[h+1]);for(n=0;n<a.length;n++)f?this.parentDom.elem.insertBefore(a[n].elem,f):this.parentDom.elem.appendChild(a[n].elem),this.siblings.push(a[n])},e}(),LeafToken=function(){function LeafToken(e,t){return this.observableRefs=[],this.dom=e,this.origin=t,this.collectObservables(),this}return LeafToken.prototype.collectObservables=function(){this.observableRefs=[];for(var variableStarted=-1,singleQuoteStarted=-1,doubleQuoteStarted=-1,i=0;i<this.origin.length;i++){var char=this.origin[i];if('"'!==char)if("'"!==char){if(!(singleQuoteStarted>-1||doubleQuoteStarted>-1))if(__leaf_isEnglishAlphabet(char)||"."===char){if(-1===variableStarted){variableStarted=i;continue}}else if(-1!==variableStarted){var variableName=this.origin.substring(variableStarted,i),observable;try{observable=eval("this.dom.context.data."+variableName)}catch(e){observable=void 0}if(void 0===observable)try{observable=eval("this.dom.context.extraData."+variableName)}catch(e){observable=void 0}if(null!=observable&&observable.postValue&&observable.__observers)this.observableRefs.push(observable);else if(__leaf_endsWith(variableName,".value")){variableName=variableName.substring(0,variableName.length-6);try{observable=eval("this.dom.context.data."+variableName)}catch(e){observable=void 0}if(void 0===observable)try{observable=eval("this.dom.context.extraData."+variableName)}catch(e){observable=void 0}null!=observable&&observable.postValue&&observable.__observers&&this.observableRefs.push(observable)}variableStarted=-1}}else singleQuoteStarted=-1===singleQuoteStarted?i:-1;else doubleQuoteStarted=-1===doubleQuoteStarted?i:-1}if(-1!==variableStarted){var variableName=this.origin.substring(variableStarted,this.origin.length),observable;try{observable=eval("this.dom.context.data."+variableName)}catch(e){observable=void 0}if(void 0===observable)try{observable=eval("this.dom.context.extraData."+variableName)}catch(e){observable=void 0}if(null!=observable&&observable.postValue&&observable.__observers)this.observableRefs.push(observable);else if(__leaf_endsWith(variableName,".value")){variableName=variableName.substring(0,variableName.length-6);try{observable=eval("this.dom.context.data."+variableName)}catch(e){observable=void 0}if(void 0===observable)try{observable=eval("this.dom.context.extraData."+variableName)}catch(e){observable=void 0}null!=observable&&observable.postValue&&observable.__observers&&this.observableRefs.push(observable)}}},LeafToken.prototype.execute=function(){var e=__leaf_executeToken(this.origin,this.dom.context.data,this.dom.context.extraData,this.dom.context.unwrapData);return e},LeafToken}(),LeafAttribute=function(){function e(e,t,r){if(this.value="",!__leaf_startsWith(t,"l-"))throw new Error("invalid executable attribute:"+t);if(this.dom=e,this.name=t.substring(2),this.tokenOrigin=r,this.token=new LeafToken(this.dom,this.tokenOrigin),__leaf_startsWith(this.name,"style-"))this.value=this.name.substring(6),this.name="style";else if(__leaf_startsWith(this.name,"class:"))this.value=this.name.substring(6),this.name="class";else if("for"===this.name)return this;for(var a=0;a<this.token.observableRefs.length;a++)(function(e,t){var r=function(t){e.execute()};t.__observers.push(r),e.dom.unbindObservables.push(function(){var e=__leaf_removeInArray(t.__observers,r);e||console.error("unbind attribute failed")})})(this,this.token.observableRefs[a]);return this}return e.prototype.rebind=function(){if(this.token.collectObservables(),__leaf_startsWith(this.name,"style-"))this.value=this.name.substring(6),this.name="style";else if(__leaf_startsWith(this.name,"class:"))this.value=this.name.substring(6),this.name="class";else if("for"===this.name)return this;for(var e=0;e<this.token.observableRefs.length;e++)(function(e,t){var r=function(t){e.execute()};t.__observers.push(r),e.dom.unbindObservables.push(function(){__leaf_removeInArray(t.__observers,r)||console.error("rebind attribute failed")})})(this,this.token.observableRefs[e])},e.prototype.execute=function(){var e=this.token.execute();e&&e.__observers&&e.postValue&&(e=e.value),"class"!==this.name?"if"!==this.name?"boolean"!=typeof e?"value"===this.name?this.dom.elem.value=e:this.dom.elem.setAttribute(this.name,e):e?this.dom.elem.setAttribute(this.name,this.value):this.dom.elem.removeAttribute(this.name):this.dom.elem.style.display=e?"":"none":e?__leaf_addClass(this.dom.elem,this.value):__leaf_removeClass(this.dom.elem,this.value)},e}(),LeafTextContent=function(){function e(e){this.tokens=[],this.template="",this.dom=e;for(var t=e.elem.childNodes,r=[],a=function(e,t){for(var r=0;r<t.length;r++)if(t[r]===e)return!0;return!1},n=0;n<t.length;n++)for(var i=String(t[n].nodeValue),s=-1,o=0;o<i.length;o++){var l=i.charAt(o),h="";if(o<i.length-1&&(h=i.charAt(o+1)),l+h!=="{{")if(s>-1&&l+h==="}}"){var f=i.substring(s+2,o),u=new LeafToken(this.dom,f);u.uniqueID=__leaf_generateID(16);for(var b=0;b<u.observableRefs.length;b++){var v=u.observableRefs[b];a(v,r)||(r.push(v),function(e,t){var r=function(t){e.execute()};t.__observers.push(r),e.dom.unbindObservables.push(function(){__leaf_removeInArray(t.__observers,r)})}(this,v))}this.tokens.push(u),s=-1,o++,this.template+=u.uniqueID}else-1===s&&(this.template+=l);else s=o}}return e.prototype.rebind=function(){for(var e=0;e<this.tokens.length;e++){this.tokens[e].collectObservables();for(var t=0;t<this.tokens[e].observableRefs.length;t++){var r=this.tokens[e].observableRefs[t];(function(e,t){var r=function(t){e.execute()};t.__observers.push(r),e.dom.unbindObservables.push(function(){__leaf_removeInArray(t.__observers,r)||console.error("rebind text content failed:")})})(this,r)}}},e.prototype.execute=function(){for(var e=this.template,t=0;t<this.tokens.length;t++){var r=this.tokens[t].execute();e=e.replace(this.tokens[t].uniqueID,r)}this.dom.elem.innerHTML=__leaf_sanitizeHTML(e)},e.checkIfNeeded=function(e){var t=e.elem.childNodes;if(e.elem.children.length>0){for(var r=0;r<t.length;r++){var a=t[r];if(a&&a instanceof Node){var n=String(a.nodeValue);if(n.indexOf("{{")>-1)throw new Error("Leaf.js currently don't support textContent binding with parentNode's other children.length>0, it may lost the binding connection when textContent update. Please wrap your textContent with a <span> or <div>: "+n)}}return!1}return e.elem.textContent.indexOf("{{")>-1},e}(),__leaf_randomIDs={},__LeafContext=function(){function e(e,t,r){this.data=e,this.extraData=t,this.unwrapData=r}return e}();